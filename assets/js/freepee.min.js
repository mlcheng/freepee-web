!function(e){"use strict";var t={MAPS_KEY:"AIzaSyBZWP8dhe4XbRxlqki5J0p2fbCdOxv9URE",OAUTH_ID:"992073863488-a3107lj0prdiih05id9n065bnhocmpve.apps.googleusercontent.com"},n={URL:"".concat(serverRoot,"api/v2/"),GOOGLE_GEODECODE_URL:"https://maps.googleapis.com/maps/api/geocode/json?key=".concat(t.GEODECODE_KEY,"&latlng=")},o="hidden",a="loading",i="search",r="map-view",s={BATHROOM_MARKER:"".concat(serverRoot,"mobile/assets/images/temp2.png")};function l(e){var t=document.createElement("span");return t.appendChild(document.createTextNode(e)),t.innerHTML}var c=Object.freeze({__proto__:null,sanitize:l}),d={map:{selectedBathroom:{},search:{place:""},location:{},instance:null},guser:{token:"",name:"",id:"",gpURL:"",pic:s.BATHROOM_MARKER,signedIn:!1},panel:{display:{detail:"false",add:"false",delete:"false"},add:{approx_address:null,description:null,submitDisabled:!1}},database:{writable:"false"}};iqwerty.http.request("".concat(n.URL,"status")).get().then((function(e){d.database.writable=e}));var u,g,m={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},p=[],h=null;function f(){v()}function y(){var e=document.getElementById("panel"),t=document.getElementById("overlay");return e.classList.remove(o),t.classList.remove(o),new Promise((function(t){e.addEventListener("transitionend",(function n(){e.removeEventListener("transitionend",n),t()}))}))}function v(){var e=document.getElementById("panel"),t=document.getElementById("overlay");e.classList.add(o),t.classList.add(o)}function b(e,t,n){var o={url:"".concat(serverRoot,"mobile/assets/images/location.png"),size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)};new google.maps.Marker({position:t,title:"My current location",icon:o}).setMap(e),new google.maps.Circle({clickable:!1,strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:e,center:t,radius:n})}function w(){var e=u.getCenter(),t=e.lat(),o=e.lng();e=new google.maps.LatLng(t,o),iqwerty.http.request("".concat(n.URL,"bathroom/get/coords/").concat(e.toUrlValue(),",").concat(u.getZoom(),"z")).get().then((function(e){var t,n,o;e&&(t=JSON.parse(e),n=[],h||(h=new google.maps.InfoWindow),o=h,t.filter((function(e){return!p.find((function(t){return e.id===t.id}))})).forEach((function(e){var t=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:s.BATHROOM_MARKER,title:e.approx_address,animation:google.maps.Animation.DROP,id:e.id});t.setMap(u),t.addListener("click",(function(){o.open(u,t),o.setContent(function(e){return new Function('return `<div class="info-window flex flex--row"><div class="flex-child flex flex--column info-window--description"><div class="address" title="${this.bathroom.approx_address}">Free Pee near ${this.bathroom.approx_address}</div><div class="description">${this.Util.sanitize(this.bathroom.description)}</div></div><div class="flex-child flex">\x3c!-- Maybe something should be done about this link... --\x3e <a class="button button--info-window" href="${serverRoot}m/bathroom/${this.bathroom.id}" onclick="iqwerty.history.pushState(\'bathroom/${this.bathroom.id}\'); return false;">more &raquo;</a></div></div>`;').call({bathroom:e,Util:c})}(e))})),n.push(t)})),p.push.apply(p,n),g?g.addMarkers(n):g=new MarkerClusterer(u,p,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"}))}))}function k(){p.forEach((function(e){e.setMap(null)})),p.length=0,g.clearMarkers(),w()}function L(){var e=document.getElementById(i);if(e.classList.toggle(o),!e.classList.contains(o)){var t=e.querySelector("input");t.value="",t.focus()}}function q(){iqwerty.toast.toast("Could not retrieve your location"),u=new google.maps.Map(document.getElementById(r),m),d.map.instance=u,B()}function _(e){var t=e.coords,n=d.map;n.location={lat:t.latitude,lng:t.longitude,accuracy:t.accuracy};var o=Object.assign({},m);o.zoom=20,o.center={lat:n.location.lat,lng:n.location.lng},u=new google.maps.Map(document.getElementById(r),o),d.map.instance=u,b(u,o.center,n.location.accuracy),B()}function B(){var e,t;document.getElementById(r).classList.remove(a),u.addListener("idle",w),u.addListener("rightclick",(function(){iqwerty.freepee.Bathroom.addBathroom()})),e=document.querySelector("#search > input"),(t=new google.maps.places.SearchBox(e)).addListener("places_changed",(function(){var e=t.getPlaces();if(e.length){var n=e.shift(),o=new google.maps.LatLngBounds;n.geometry.viewport?o.union(n.geometry.viewport):o.extend(n.geometry.location),u.fitBounds(o)}})),e.addEventListener("keyup",(function(e){27===e.which&&L()}))}var R,E,O,M,I=Object.freeze({__proto__:null,BaseStateController:f,openPanel:y,closePanel:v,getLocation:function(){var e=_,t=q;if(!("geolocation"in navigator))return t(),!1;navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!1,timeout:1e4})},addMyLocationMarker:b,getBathrooms:w,reloadMap:k,toggleSearch:L}),x=new Promise((function(e){R=e})),S=new Promise((function(e){E=e})),U={map:{loaded:function(){return x},resolve:R},auth:{loaded:function(){return S},resolve:E}};function C(){document.getElementById("sign-in--google").children[0].click()}function T(){}function A(){iqwerty.snackbar.snackbar("Login failed","Try again",C,{settings:{duration:6e3}})}function P(e){if(e){document.getElementById("sign-in--google").style.display="none";var t=d.guser;iqwerty.http.request("".concat(n.URL,"login")).post({gid:t.id,ukey:t.token})}else document.getElementById("sign-in--google").style.display=""}function z(e){M=e;var t=e.getBasicProfile();if(t){var n=d.guser;n.token=M.getAuthResponse().id_token,n.name=t.getGivenName(),n.id=t.getId(),n.gpURL="https://plus.google.com/".concat(n.id),n.pic=t.getImageUrl(),n.token&&(d.guser.signedIn=!0),U.auth.resolve()}}function D(){if(!document.getElementById("sign-in--google"))return setTimeout(D);gapi.signin2.render("sign-in--google",{scope:"email profile",width:110,height:30,theme:"dark",onsuccess:T,onfailure:A})}var j,H=Object.freeze({__proto__:null,loadAuth:function(){gapi.load("auth2",(function(){(O=gapi.auth2.init({client_id:t.OAUTH_ID,scope:"email profile"})).isSignedIn.listen(P),O.currentUser.listen(z),O.isSignedIn.get()?O.signIn():U.auth.resolve(),setTimeout(D)}))},signIn:C,loginSuccess:T,loginFailure:A,logout:function(){O.disconnect(),d.guser.signedIn=!1}}),N={zoom:18,zoomControl:!0,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,disableDoubleClickZoom:!0,streetViewControl:!0};function $(e){G(e)}function G(e){document.querySelector("."+a).classList.remove(o),y().then((function(){iqwerty.http.request("".concat(n.URL,"bathroom/get/id/").concat(e)).get().then((function(t){(function(e){Y(),d.panel.display.detail="true",d.panel.display.add="false",e.description=l(e.description),Object.assign(d.map.selectedBathroom,e)})(t=JSON.parse(t)[0]),U.map.loaded().then((function(){F({lat:t.lat,lng:t.lng}),function(e){new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:s.BATHROOM_MARKER}).setMap(j)}(t)})),U.auth.loaded().then((function(){!function(e,t){$http("".concat(n.URL,"bathroom/query/id/").concat(e)).get({vote:!0,gid:t}).then((function(e){d.map.selectedBathroom.myRating=JSON.parse(e).vote}))}(e,d.guser.id),d.panel.display.delete=t.userid===d.guser.id}))}))}))}function J(){v(),j=null}function K(e){iqwerty.http.request("".concat(n.URL,"bathroom/vote/").concat(e,"/").concat(d.map.selectedBathroom.id)).post({gid:d.guser.id,ukey:d.guser.token}).then((function(t){iqwerty.toast.toast("Thank you for your contribution!");var n=JSON.parse(t);delete n.total_score,Object.keys(n).forEach((function(e){d.map.selectedBathroom[e]=n[e]})),d.map.selectedBathroom.myRating="up"===e?1:-1})).catch((function(){return iqwerty.toast.toast("You must be logged in to vote")}))}function Y(){document.querySelector("."+a).classList.add(o)}function F(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:N;(j=new google.maps.Map(document.getElementById("map-view-small"),n)).setCenter({lat:t.lat,lng:t.lng});var o=d.map.location,a=o.lat,i=o.lng,r=o.accuracy;b(j,{lat:a,lng:i},r)}var W={Apis:U,Bathroom:Object.freeze({__proto__:null,BathroomStateController:$,openPanel:G,closePanel:J,addBathroom:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d.map.instance.getCenter();if(d.guser.token){y(),Y(),d.panel.display.detail="false",d.panel.display.add="true";var t=Object.assign({},N);t.draggable=!0;var o=d.map.location,a=o.lat,i=o.lng;F({lat:a,lng:i},{lat:e.lat(),lng:e.lng()},t),j.addListener("idle",(function(){iqwerty.http.request("".concat(n.URL,"geocode/get/coords/").concat(j.center.lat(),",").concat(j.center.lng())).get().then((function(e){e=JSON.parse(e),d.panel.add.approx_address=e.results.shift().formatted_address}))}))}else iqwerty.snackbar.snackbar("You are not logged in","Login",C,{settings:{duration:6e3}})},editBathroom:function(e){if(d.guser.signedIn&&"true"!==e.contentEditable){e.contentEditable=!0,e.focus();var t=e.innerText;e.addEventListener("blur",(function(){e.removeAttribute("contenteditable"),e.innerText!==t&&iqwerty.http.request("".concat(n.URL,"bathroom/edit/id/").concat(d.map.selectedBathroom.id)).post({gid:d.guser.id,ukey:d.guser.token,desc:e.innerText}).then((function(){iqwerty.toast.toast("Thank you for your contribution!")})).catch((function(){return iqwerty.toast.toast("You must be logged in to edit")}))}),{once:!0})}},create:function(){var e=document.querySelector("#panel-view [contenteditable]");d.panel.add.submitDisabled=!0;var t=new google.maps.LatLng(j.center.lat(),j.center.lng());iqwerty.http.request("".concat(n.URL,"bathroom/create")).post({gid:d.guser.id,ukey:d.guser.token,coords:"".concat(t.lat(),",").concat(t.lng()),desc:e.innerText}).then((function(){d.panel.add.submitDisabled=!1,e.innerText="",iqwerty.toast.toast("Thank you for your contribution!"),J(),w()})).catch((function(){d.panel.add.submitDisabled=!1,iqwerty.snackbar.snackbar("Sorry, there was an error. Try reloading the page?","Reload",(function(){window.location.reload()}))}))},remove:function(){window.confirm("Are you sure you want to delete this bathroom?")&&iqwerty.http.request("".concat(n.URL,"bathroom/delete/id/").concat(d.map.selectedBathroom.id)).post({gid:d.guser.id,ukey:d.guser.token}).then((function(){iqwerty.history.pushState(""),J(),k()})).catch((function(){return iqwerty.toast.toast("You must have added this bathroom to delete it.")}))},upvote:function(){K("up")},downvote:function(){K("down")}}),Callback:Object.freeze({__proto__:null,panelLoadedCallback:function(){iqwerty.binding.model({bathroom:d.map.selectedBathroom,panel:d.panel,search:d.map.search}),iqwerty.history.setStates({"":f,"bathroom/:id":$},{base:"".concat(serverRoot,"m/")})},toolbarLoadedCallback:function(){iqwerty.binding.model({database:d.database,guser:d.guser})}}),Google:H,MainMap:I};e.freepee=W}(this.iqwerty=this.iqwerty||{});
