"use strict";var iqwerty=iqwerty||{};iqwerty.freepee=iqwerty.freepee||{};var Constants=iqwerty.freepee.Constants,__view__={guser:{signedIn:!1},panel:{display:{detail:"false",add:"false"}}};iqwerty.freepee.Map=function(){function locationUnavailable(){iqwerty.toast.Toast("Geolocation is not supported on your device"),initBasicMap()}function locationAvailable(){return"geolocation"in navigator}function initBasicMap(){_map=new google.maps.Map(document.getElementById(MAP_VIEW),DEFAULT_MAP_OPTIONS),updateMapOnMoved()}function initMap(e){var t=e.coords;exports.location={lat:t.latitude,lng:t.longitude,accuracy:t.accuracy};var o=Object.assign({},DEFAULT_MAP_OPTIONS);o.zoom=20,o.center={lat:exports.location.lat,lng:exports.location.lng},_map=new google.maps.Map(document.getElementById(MAP_VIEW),o),exports.addMyLocationMarker(_map,o.center,exports.location.accuracy),updateMapOnMoved()}function updateMapOnMoved(){_map.addListener("idle",getBathrooms)}function getBathrooms(){var e=_map.getCenter();$http(Constants.API.URL+"bathroom/get/coords/"+e.lat()+","+e.lng()+","+_map.getZoom()+"z").cache().get().then(function(e){e&&attachBathrooms(JSON.parse(e))})}function attachBathrooms(e){var t=[],o=createInfoWindow();e.filter(function(e){return!_markers.find(function(t){return e.id===t.id})}).forEach(function(e){var n=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER,title:e.approx_address,animation:google.maps.Animation.DROP,id:e.id});n.setMap(_map),n.addListener("click",function(){o.open(_map,n),o.setContent(getInfoWindowContent(e))}),t.push(n)}),_markers.push.apply(_markers,t),_markerClusterer?_markerClusterer.addMarkers(t):_markerClusterer=new MarkerClusterer(_map,_markers,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"})}function createInfoWindow(){return _infoWindow||(_infoWindow=new google.maps.InfoWindow),_infoWindow}function getInfoWindowContent(bathroom){var template=eval('`<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">${bathroom.description}</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>`');return template}var exports={},MAP_VIEW="map-view",DEFAULT_MAP_OPTIONS={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},_map,_markers=[],_markerClusterer,_infoWindow=null;return exports.selectedBathroom={},exports.search={place:""},exports.location={},exports.BaseStateController=function(){exports.closePanel()},exports.BathroomStateController=function(e){iqwerty.freepee.Bathroom.openPanel(e)},exports.openPanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");e.classList.remove(Constants.Iden.HIDDEN),t.classList.remove(Constants.Iden.HIDDEN)},exports.closePanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");e.classList.add(Constants.Iden.HIDDEN),t.classList.add(Constants.Iden.HIDDEN)},exports.getLocation=function(){var e=initMap,t=locationUnavailable,o={enableHighAccuracy:!1,timeout:1e4};return locationAvailable()?void navigator.geolocation.getCurrentPosition(e,t,o):(t(),!1)},exports.addMyLocationMarker=function(e,t,o){var n={url:serverRoot+"mobile/assets/images/location.png",size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)},a=new google.maps.Marker({position:t,title:"My current location",icon:n});a.setMap(e),new google.maps.Circle({strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:e,center:t,radius:o})},exports.toggleSearch=function(){var e=document.getElementById(Constants.Iden.SEARCH);e.classList.toggle(Constants.Iden.HIDDEN),e.classList.contains(Constants.Iden.HIDDEN)||e.querySelector("input").focus()},exports}(),iqwerty.freepee.Bathroom=function(){function e(e){$http(Constants.API.URL+"bathroom/vote/"+e+"/"+iqwerty.freepee.Map.selectedBathroom.id).post({gid:iqwerty.freepee.Google.guser.id,ukey:iqwerty.freepee.Google.guser.token}).then(function(e){iqwerty.toast.Toast("Thank you for your contribution!");var t=JSON.parse(e);delete t.total_score,Object.keys(t).forEach(function(e){iqwerty.freepee.Map.selectedBathroom[e]=t[e]})}).catch(function(){return iqwerty.toast.Toast("You must be logged in to vote")})}function t(){document.querySelector("."+Constants.Iden.LOADING).classList.remove(Constants.Iden.HIDDEN)}function o(){document.querySelector("."+Constants.Iden.LOADING).classList.add(Constants.Iden.HIDDEN)}function n(e){var t=arguments.length<=1||void 0===arguments[1]?c:arguments[1];"undefined"==typeof google&&setTimeout(function(){return n(e,t)},100),i=new google.maps.Map(document.getElementById(l),t),i.setCenter({lat:e.lat,lng:e.lng});var o=iqwerty.freepee.Map.location,a=o.lat,r=o.lng,s=o.accuracy;iqwerty.freepee.Map.addMyLocationMarker(i,{lat:a,lng:r},s)}function a(e){var t=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER});t.setMap(i)}function r(e){o(),__view__.panel.display.detail="true",__view__.panel.display.add="",Object.assign(iqwerty.freepee.Map.selectedBathroom,e)}var i,s={},l="map-view-small",c={zoom:18,zoomControl:!0,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,disableDoubleClickZoom:!0,streetViewControl:!0};return s.openPanel=function(e){t(),iqwerty.freepee.Map.openPanel(),$http(Constants.API.URL+"bathroom/get/id/"+e).cache().get().then(function(e){e=JSON.parse(e)[0],r(e),n({lat:e.lat,lng:e.lng}),a(e)})},s.closePanel=function(){iqwerty.freepee.Map.closePanel(),i=null},s.addBathroom=function(){iqwerty.freepee.Map.openPanel(),o(),__view__.panel.display.detail="",__view__.panel.display.add="true"},s.upvote=function(){e("up")},s.downvote=function(){e("down")},s}(),iqwerty.freepee.Google=function(){function e(e){e?(document.getElementById(r).style.display="none",$http(Constants.API.URL+"login").post({gid:i.guser.id,ukey:i.guser.token})):document.getElementById(r).style.display=""}function t(e){a=e;var t=e.getBasicProfile();t&&(i.guser.token=a.getAuthResponse().id_token,i.guser.name=t.getGivenName(),i.guser.id=t.getId(),i.guser.gpURL="https://plus.google.com/"+i.guser.id,i.guser.pic=t.getImageUrl(),i.guser.token&&(__view__.guser.signedIn=!0),console.log(a,i.guser))}function o(){gapi.signin2.render(r,{scope:"email profile",width:110,height:30,theme:"dark",onsuccess:iqwerty.freepee.Google.loginSuccess,onfailure:iqwerty.freepee.Google.loginFailure})}var n,a,r="sign-in--google",i={};return i.guser={token:"",name:"",id:"",gpURL:"",pic:Constants.ToiletImage.BATHROOM_MARKER},i.loadAuth=function(){gapi.load("auth2",function(){n=gapi.auth2.init({client_id:Constants.Google.OAUTH_ID,scope:"email profile"}),n.isSignedIn.listen(e),n.currentUser.listen(t),n.isSignedIn.get()&&n.signIn(),setTimeout(function(){return o()})})},i.loginSuccess=function(){},i.loginFailure=function(){iqwerty.snackbar.Snackbar("Login failed","Try again",function(){document.getElementById(r).children[0].click()},{settings:{duration:6e3}})},i.logout=function(){n.disconnect(),__view__.guser.signedIn=!1},i}();var __template={bindBathroomData:function(){iqwerty.binding.Model({bathroom:iqwerty.freepee.Map.selectedBathroom,search:iqwerty.freepee.Map.search}),iqwerty.history.States({"":iqwerty.freepee.Map.BaseStateController,"bathroom/:id":iqwerty.freepee.Map.BathroomStateController},{base:serverRoot+"m/"})},bindToolbarData:function(){iqwerty.binding.Model({guser:iqwerty.freepee.Google.guser,view:__view__})}};