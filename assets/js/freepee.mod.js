"use strict";window.require=function e(o,t,n){function a(r,s){if(!t[r]){if(!o[r]){var l="function"==typeof require&&require;if(!s&&l)return l(r,!0);if(i)return i(r,!0);var d=new Error("Cannot find module '"+r+"'");throw d.code="MODULE_NOT_FOUND",d}var c=t[r]={exports:{}};o[r][0].call(c.exports,function(e){var t=o[r][1][e];return a(t||e)},c,c.exports,e,o,t,n)}return t[r].exports}for(var i="function"==typeof require&&require,r=0;r<n.length;r++)a(n[r]);return a}({1:[function(e,o,t){var n={};n.Google={MAPS_KEY:"AIzaSyAp7WgpI5MFyR1HgnGO8tHdjv8RVm_flQU",OAUTH_ID:"992073863488-a3107lj0prdiih05id9n065bnhocmpve.apps.googleusercontent.com"},n.API={URL:serverRoot+"api/v2/",GOOGLE_GEODECODE_URL:"https://maps.googleapis.com/maps/api/geocode/json?key="+n.Google.GEODECODE_KEY+"&latlng="},n.Iden={HIDDEN:"hidden",LOADING:"loading",SEARCH:"search"},n.ToiletImage={BATHROOM_MARKER:serverRoot+"mobile/assets/images/temp2.png"},void 0!==o&&(o.exports=n)},{}],2:[function(e,o,t){function n(e){$http(c.API.URL+"bathroom/vote/"+e+"/"+u.model.map.selectedBathroom.id).post({gid:u.model.user.guser.id,ukey:u.model.user.guser.token}).then(function(o){iqwerty.toast.Toast("Thank you for your contribution!");var t=JSON.parse(o);delete t.total_score,Object.keys(t).forEach(function(e){u.model.map.selectedBathroom[e]=t[e]}),u.model.map.selectedBathroom.myRating="up"===e?1:-1}).catch(function(){return iqwerty.toast.Toast("You must be logged in to vote")})}function a(){document.querySelector("."+c.Iden.LOADING).classList.remove(c.Iden.HIDDEN)}function i(){document.querySelector("."+c.Iden.LOADING).classList.add(c.Iden.HIDDEN)}function r(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v;"undefined"==typeof google&&setTimeout(function(){return r(e,t)},100),h=new google.maps.Map(document.getElementById(f),t),h.setCenter({lat:o.lat,lng:o.lng});var n=u.model.map.location,a=n.lat,i=n.lng,s=n.accuracy;m.addMyLocationMarker(h,{lat:a,lng:i},s)}function s(e){new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:c.ToiletImage.BATHROOM_MARKER}).setMap(h)}function l(e){i(),u.model.view.panel.display.detail="true",u.model.view.panel.display.add="false",Object.assign(u.model.map.selectedBathroom,e)}function d(e,o){$http(c.API.URL+"bathroom/query/id/"+e).get({vote:!0,gid:o}).then(function(e){u.model.map.selectedBathroom.myRating=JSON.parse(e).vote})}var c=e("../../../../assets/js/constants"),m=e("./mainmap"),u=e("./viewmodel"),g=e("./google"),p=o.exports,f="map-view-small",v={zoom:18,zoomControl:!0,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,disableDoubleClickZoom:!0,streetViewControl:!0},h=void 0;p.openPanel=function(e){a(),m.openPanel().then(function(){$http(c.API.URL+"bathroom/get/id/"+e).cache().get().then(function(o){o=JSON.parse(o)[0],l(o),r({lat:o.lat,lng:o.lng}),s(o),u.model.user.guser.id&&d(e,u.model.user.guser.id)})})},p.closePanel=function(){m.closePanel(),h=null},p.addBathroom=function(){if(!u.model.user.guser.token)return void iqwerty.snackbar.Snackbar("You are not logged in","Login",g.signIn,{settings:{duration:6e3}});m.openPanel(),i(),u.model.view.panel.display.detail="false",u.model.view.panel.display.add="true";var e=Object.assign({},v);e.draggable=!0;var o=u.model.map.location,t=o.lat,n=o.lng,a=u.model.map.instance.getCenter();r({lat:t,lng:n},{lat:a.lat(),lng:a.lng()},e),h.addListener("idle",function(){$http(c.API.URL+"geocode/get/coords/"+h.center.lat()+","+h.center.lng()).get().then(function(e){e=JSON.parse(e),u.model.view.panel.add.approx_address=e.results.shift().formatted_address})})},p.create=function(){u.model.view.panel.add.submitDisabled=!0,$http(c.API.URL+"bathroom/create").post().then(function(e){u.model.view.panel.add.submitDisabled=!1}).catch(function(){u.model.view.panel.add.submitDisabled=!1,iqwerty.snackbar.Snackbar("Sorry, there was an error. Try reloading the page?","Reload",function(){window.location.reload()})})},p.upvote=function(){n("up")},p.downvote=function(){n("down")}},{"../../../../assets/js/constants":1,"./google":3,"./mainmap":4,"./viewmodel":5}],3:[function(e,o,t){function n(e){if(e){document.getElementById(l).style.display="none";var o=s.model.user.guser;$http(r.API.URL+"login").post({gid:o.id,ukey:o.token})}else document.getElementById(l).style.display=""}function a(e){m=e;var o=e.getBasicProfile();if(o){var t=s.model.user.guser;t.token=m.getAuthResponse().id_token,t.name=o.getGivenName(),t.id=o.getId(),t.gpURL="https://plus.google.com/"+t.id,t.pic=o.getImageUrl(),t.token&&(s.model.view.guser.signedIn=!0),console.log(m,s.model.user.guser)}}function i(){gapi.signin2.render(l,{scope:"email profile",width:110,height:30,theme:"dark",onsuccess:d.loginSuccess,onfailure:d.loginFailure})}var r=e("../../../../assets/js/constants"),s=e("./viewmodel"),l="sign-in--google",d=o.exports,c=void 0,m=void 0;d.loadAuth=function(){gapi.load("auth2",function(){c=gapi.auth2.init({client_id:r.Google.OAUTH_ID,scope:"email profile"}),c.isSignedIn.listen(n),c.currentUser.listen(a),c.isSignedIn.get()&&c.signIn(),setTimeout(function(){return i()})})},d.signIn=function(){document.getElementById(l).children[0].click()},d.loginSuccess=function(){},d.loginFailure=function(){iqwerty.snackbar.Snackbar("Login failed","Try again",d.signIn,{settings:{duration:6e3}})},d.logout=function(){c.disconnect(),s.model.view.guser.signedIn=!1}},{"../../../../assets/js/constants":1,"./viewmodel":5}],4:[function(require,module,exports){function locationUnavailable(){iqwerty.toast.Toast("Geolocation is not supported on your device"),initBasicMap()}function locationAvailable(){return"geolocation"in navigator}function initBasicMap(){_map=new google.maps.Map(document.getElementById(MAP_VIEW),DEFAULT_MAP_OPTIONS),ViewModel.model.map.instance=_map,updateMapOnMoved()}function initMap(e){var o=e.coords,t=ViewModel.model.map;t.location={lat:o.latitude,lng:o.longitude,accuracy:o.accuracy};var n=Object.assign({},DEFAULT_MAP_OPTIONS);n.zoom=20,n.center={lat:t.location.lat,lng:t.location.lng},_map=new google.maps.Map(document.getElementById(MAP_VIEW),n),ViewModel.model.map.instance=_map,shell.addMyLocationMarker(_map,n.center,t.location.accuracy),updateMapOnMoved()}function updateMapOnMoved(){_map.addListener("idle",getBathrooms)}function getBathrooms(){var e=_map.getCenter();$http(Constants.API.URL+"bathroom/get/coords/"+e.lat()+","+e.lng()+","+_map.getZoom()+"z").cache().get().then(function(e){e&&attachBathrooms(JSON.parse(e))})}function attachBathrooms(e){var o=[],t=createInfoWindow();e.filter(function(e){return!_markers.find(function(o){return e.id===o.id})}).forEach(function(e){var n=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER,title:e.approx_address,animation:google.maps.Animation.DROP,id:e.id});n.setMap(_map),n.addListener("click",function(){t.open(_map,n),t.setContent(getInfoWindowContent(e))}),o.push(n)}),_markers.push.apply(_markers,o),_markerClusterer?_markerClusterer.addMarkers(o):_markerClusterer=new MarkerClusterer(_map,_markers,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"})}function createInfoWindow(){return _infoWindow||(_infoWindow=new google.maps.InfoWindow),_infoWindow}function getInfoWindowContent(bathroom){var template='<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${bathroom.description}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>';return eval('`<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${bathroom.description}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>`')}var Constants=require("../../../../assets/js/constants"),Bathroom=require("./bathroom"),ViewModel=require("./viewmodel"),shell=module.exports,MAP_VIEW="map-view",DEFAULT_MAP_OPTIONS={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},_map=void 0,_markers=[],_markerClusterer=void 0,_infoWindow=null;shell.BaseStateController=function(){shell.closePanel()},shell.BathroomStateController=function(e){Bathroom.openPanel(e)},shell.openPanel=function(){var e=document.getElementById("panel"),o=document.getElementById("overlay");return e.classList.remove(Constants.Iden.HIDDEN),o.classList.remove(Constants.Iden.HIDDEN),new Promise(function(o){var t=function t(){e.removeEventListener("transitionend",t),o()};e.addEventListener("transitionend",t)})},shell.closePanel=function(){var e=document.getElementById("panel"),o=document.getElementById("overlay");e.classList.add(Constants.Iden.HIDDEN),o.classList.add(Constants.Iden.HIDDEN)},shell.getLocation=function(){var e=initMap,o=locationUnavailable,t={enableHighAccuracy:!1,timeout:1e4};if(!locationAvailable())return o(),!1;navigator.geolocation.getCurrentPosition(e,o,t)},shell.addMyLocationMarker=function(e,o,t){var n={url:serverRoot+"mobile/assets/images/location.png",size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)};new google.maps.Marker({position:o,title:"My current location",icon:n}).setMap(e),new google.maps.Circle({strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:e,center:o,radius:t})},shell.toggleSearch=function(){var e=document.getElementById(Constants.Iden.SEARCH);e.classList.toggle(Constants.Iden.HIDDEN),e.classList.contains(Constants.Iden.HIDDEN)||e.querySelector("input").focus()}},{"../../../../assets/js/constants":1,"./bathroom":2,"./viewmodel":5,fs:6}],5:[function(e,o,t){var n=e("../../../../assets/js/constants"),a=e("./mainmap"),i=o.exports;i.model={map:{selectedBathroom:{},search:{place:""},location:{},instance:null},user:{guser:{token:"",name:"",id:"",gpURL:"",pic:n.ToiletImage.BATHROOM_MARKER}},view:{guser:{signedIn:!1},panel:{display:{detail:"false",add:"false"},add:{approx_address:null,description:null,submitDisabled:!1}}}},i.template={bindBathroomData:function(){iqwerty.binding.Model({bathroom:i.model.map.selectedBathroom,search:i.model.map.search}),iqwerty.history.States({"":a.BaseStateController,"bathroom/:id":a.BathroomStateController},{base:serverRoot+"m/"})},bindToolbarData:function(){iqwerty.binding.Model({guser:i.model.user.guser,view:i.model.view})}}},{"../../../../assets/js/constants":1,"./mainmap":4}],6:[function(e,o,t){},{}],"iqwerty-freepee":[function(e,o,t){var n=e("../../../assets/js/constants"),a=e("./modules/mainmap"),i=e("./modules/bathroom"),r=e("./modules/google"),s=e("./modules/viewmodel");void 0!==o&&(o.exports={Constants:n,MainMap:a,Bathroom:i,Google:r,ViewModel:s})},{"../../../assets/js/constants":1,"./modules/bathroom":2,"./modules/google":3,"./modules/mainmap":4,"./modules/viewmodel":5}]},{},["iqwerty-freepee"]);