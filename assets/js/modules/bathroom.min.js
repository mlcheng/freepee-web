"use strict";function vote(e){$http(Constants.API.URL+"bathroom/vote/"+e+"/"+ViewModel.model.map.selectedBathroom.id).post({gid:ViewModel.model.user.guser.id,ukey:ViewModel.model.user.guser.token}).then(function(o){iqwerty.toast.Toast("Thank you for your contribution!");var t=JSON.parse(o);delete t.total_score,Object.keys(t).forEach(function(e){ViewModel.model.map.selectedBathroom[e]=t[e]}),ViewModel.model.map.selectedBathroom.myRating="up"===e?1:-1}).catch(function(){return iqwerty.toast.Toast("You must be logged in to vote")})}function showLoading(){document.querySelector("."+Constants.Iden.LOADING).classList.remove(Constants.Iden.HIDDEN)}function hideLoading(){document.querySelector("."+Constants.Iden.LOADING).classList.add(Constants.Iden.HIDDEN)}function initMap(e){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:DEFAULT_SMALL_MAP_OPTIONS;"undefined"==typeof google&&setTimeout(function(){return initMap(e,t)},100),_map=new google.maps.Map(document.getElementById(MAP_VIEW_SMALL),t),_map.setCenter({lat:o.lat,lng:o.lng});var a=ViewModel.model.map.location,n=a.lat,l=a.lng,i=a.accuracy;MainMap.addMyLocationMarker(_map,{lat:n,lng:l},i)}function attachBathroom(e){new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER}).setMap(_map)}function bindBathroomData(e){hideLoading(),ViewModel.model.view.panel.display.detail="true",ViewModel.model.view.panel.display.add="false",Object.assign(ViewModel.model.map.selectedBathroom,e)}function getMyRating(e,o){$http(Constants.API.URL+"bathroom/query/id/"+e).get({vote:!0,gid:o}).then(function(e){ViewModel.model.map.selectedBathroom.myRating=JSON.parse(e).vote})}var Constants=require("../../../../assets/js/constants"),MainMap=require("./mainmap"),ViewModel=require("./viewmodel"),Google=require("./google"),shell=module.exports,MAP_VIEW_SMALL="map-view-small",DEFAULT_SMALL_MAP_OPTIONS={zoom:18,zoomControl:!0,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,disableDoubleClickZoom:!0,streetViewControl:!0},_map=void 0;shell.openPanel=function(e){showLoading(),MainMap.openPanel(),$http(Constants.API.URL+"bathroom/get/id/"+e).cache().get().then(function(o){o=JSON.parse(o)[0],bindBathroomData(o),initMap({lat:o.lat,lng:o.lng}),attachBathroom(o),ViewModel.model.user.guser.id&&getMyRating(e,ViewModel.model.user.guser.id)})},shell.closePanel=function(){MainMap.closePanel(),_map=null},shell.addBathroom=function(){if(!ViewModel.model.user.guser.token)return void iqwerty.snackbar.Snackbar("You are not logged in","Login",Google.signIn,{settings:{duration:6e3}});MainMap.openPanel(),hideLoading(),ViewModel.model.view.panel.display.detail="false",ViewModel.model.view.panel.display.add="true";var e=Object.assign({},DEFAULT_SMALL_MAP_OPTIONS);e.draggable=!0;var o=ViewModel.model.map.location,t=o.lat,a=o.lng,n=ViewModel.model.map.instance.getCenter();initMap({lat:t,lng:a},{lat:n.lat(),lng:n.lng()},e),_map.addListener("idle",function(){$http(""+Constants.API.GOOGLE_GEODECODE_URL+_map.center.lat()+","+_map.center.lng()).get().then(function(e){e=JSON.parse(e),ViewModel.model.view.panel.add.approx_address=e.results.shift().formatted_address})})},shell.upvote=function(){vote("up")},shell.downvote=function(){vote("down")};