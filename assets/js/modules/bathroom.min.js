"use strict";function vote(e){$http(Constants.API.URL+"bathroom/vote/"+e+"/"+ViewModel.model.map.selectedBathroom.id).post({gid:ViewModel.model.user.guser.id,ukey:ViewModel.model.user.guser.token}).then(function(t){iqwerty.toast.Toast("Thank you for your contribution!");var o=JSON.parse(t);delete o.total_score,Object.keys(o).forEach(function(e){ViewModel.model.map.selectedBathroom[e]=o[e]}),ViewModel.model.map.selectedBathroom.myRating="up"===e?1:-1}).catch(function(){return iqwerty.toast.Toast("You must be logged in to vote")})}function showLoading(){document.querySelector("."+Constants.Iden.LOADING).classList.remove(Constants.Iden.HIDDEN)}function hideLoading(){document.querySelector("."+Constants.Iden.LOADING).classList.add(Constants.Iden.HIDDEN)}function initMap(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:DEFAULT_SMALL_MAP_OPTIONS;_map=new google.maps.Map(document.getElementById(MAP_VIEW_SMALL),o),_map.setCenter({lat:t.lat,lng:t.lng});var n=ViewModel.model.map.location,a=n.lat,i=n.lng,l=n.accuracy;MainMap.addMyLocationMarker(_map,{lat:a,lng:i},l)}function attachBathroom(e){new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER}).setMap(_map)}function bindBathroomData(e){hideLoading(),ViewModel.model.view.panel.display.detail="true",ViewModel.model.view.panel.display.add="false",e.description=Util.sanitize(e.description),Object.assign(ViewModel.model.map.selectedBathroom,e)}function getMyRating(e,t){$http(Constants.API.URL+"bathroom/query/id/"+e).get({vote:!0,gid:t}).then(function(e){ViewModel.model.map.selectedBathroom.myRating=JSON.parse(e).vote})}var Constants=require("../../../../assets/js/constants"),Util=require("../../../../assets/js/util"),MainMap=require("./mainmap"),ViewModel=require("./viewmodel"),Google=require("./google"),Apis=require("./apis"),shell=module.exports,MAP_VIEW_SMALL="map-view-small",DEFAULT_SMALL_MAP_OPTIONS={zoom:18,zoomControl:!0,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,disableDoubleClickZoom:!0,streetViewControl:!0},_map=void 0;shell.openPanel=function(e){showLoading(),MainMap.openPanel().then(function(){$http(Constants.API.URL+"bathroom/get/id/"+e).get().then(function(t){t=JSON.parse(t)[0],bindBathroomData(t),Apis.map.loaded().then(function(){initMap({lat:t.lat,lng:t.lng}),attachBathroom(t)}),Apis.auth.loaded().then(function(){getMyRating(e,ViewModel.model.user.guser.id),ViewModel.model.view.panel.display.delete=t.userid===ViewModel.model.user.guser.id})})})},shell.closePanel=function(){MainMap.closePanel(),_map=null},shell.addBathroom=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ViewModel.model.map.instance.getCenter();if(!ViewModel.model.user.guser.token)return void iqwerty.snackbar.Snackbar("You are not logged in","Login",Google.signIn,{settings:{duration:6e3}});MainMap.openPanel(),hideLoading(),ViewModel.model.view.panel.display.detail="false",ViewModel.model.view.panel.display.add="true";var t=Object.assign({},DEFAULT_SMALL_MAP_OPTIONS);t.draggable=!0;var o=ViewModel.model.map.location;initMap({lat:o.lat,lng:o.lng},{lat:e.lat(),lng:e.lng()},t),_map.addListener("idle",function(){$http(Constants.API.URL+"geocode/get/coords/"+_map.center.lat()+","+_map.center.lng()).get().then(function(e){e=JSON.parse(e),ViewModel.model.view.panel.add.approx_address=e.results.shift().formatted_address})})},shell.editBathroom=function(e){if(ViewModel.model.view.guser.signedIn&&"true"!==e.contentEditable){e.contentEditable=!0,e.focus();var t=e.innerText;e.addEventListener("blur",function(){e.removeAttribute("contenteditable"),e.innerText!==t&&$http(Constants.API.URL+"bathroom/edit/id/"+ViewModel.model.map.selectedBathroom.id).post({gid:ViewModel.model.user.guser.id,ukey:ViewModel.model.user.guser.token,desc:e.innerText}).then(function(){iqwerty.toast.Toast("Thank you for your contribution!")}).catch(function(){return iqwerty.toast.Toast("You must be logged in to edit")})},{once:!0})}},shell.create=function(){var e=document.querySelector("#panel-view [contenteditable]");ViewModel.model.view.panel.add.submitDisabled=!0;var t=new google.maps.LatLng(_map.center.lat(),_map.center.lng());$http(Constants.API.URL+"bathroom/create").post({gid:ViewModel.model.user.guser.id,ukey:ViewModel.model.user.guser.token,coords:t.lat()+","+t.lng(),desc:e.innerText}).then(function(){ViewModel.model.view.panel.add.submitDisabled=!1,e.innerText="",iqwerty.toast.Toast("Thank you for your contribution!"),shell.closePanel(),MainMap.getBathrooms()}).catch(function(){ViewModel.model.view.panel.add.submitDisabled=!1,iqwerty.snackbar.Snackbar("Sorry, there was an error. Try reloading the page?","Reload",function(){window.location.reload()})})},shell.delete=function(){window.confirm("Are you sure you want to delete this bathroom?")&&$http(Constants.API.URL+"bathroom/delete/id/"+ViewModel.model.map.selectedBathroom.id).post({gid:ViewModel.model.user.guser.id,ukey:ViewModel.model.user.guser.token}).then(function(){iqwerty.history.Push(""),shell.closePanel(),MainMap.reloadMap()}).catch(function(){return iqwerty.toast.Toast("You must have added this bathroom to delete it.")})},shell.upvote=function(){vote("up")},shell.downvote=function(){vote("down")};