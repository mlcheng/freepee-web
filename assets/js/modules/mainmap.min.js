"use strict";function locationUnavailable(){iqwerty.toast.Toast("Geolocation is not supported on your device"),initBasicMap()}function locationAvailable(){return"geolocation"in navigator}function initBasicMap(){_map=new google.maps.Map(document.getElementById(MAP_VIEW),DEFAULT_MAP_OPTIONS),ViewModel.model.map.instance=_map,updateMapOnMoved()}function initMap(e){var t=e.coords,o=ViewModel.model.map;o.location={lat:t.latitude,lng:t.longitude,accuracy:t.accuracy};var n=Object.assign({},DEFAULT_MAP_OPTIONS);n.zoom=20,n.center={lat:o.location.lat,lng:o.location.lng},_map=new google.maps.Map(document.getElementById(MAP_VIEW),n),ViewModel.model.map.instance=_map,shell.addMyLocationMarker(_map,n.center,o.location.accuracy),updateMapOnMoved(),addBathroomOnClick(),setupSearch()}function updateMapOnMoved(){_map.addListener("idle",shell.getBathrooms)}function addBathroomOnClick(){_map.addListener("rightclick",function(e){Bathroom.addBathroom(e.latLng)})}function attachBathrooms(e){var t=[],o=createInfoWindow();e.filter(function(e){return!_markers.find(function(t){return e.id===t.id})}).forEach(function(e){var n=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER,title:e.approx_address,animation:google.maps.Animation.DROP,id:e.id});n.setMap(_map),n.addListener("click",function(){o.open(_map,n),o.setContent(getInfoWindowContent(e))}),t.push(n)}),_markers.push.apply(_markers,t),_markerClusterer?_markerClusterer.addMarkers(t):_markerClusterer=new MarkerClusterer(_map,_markers,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"})}function createInfoWindow(){return _infoWindow||(_infoWindow=new google.maps.InfoWindow),_infoWindow}function getInfoWindowContent(bathroom){var template='<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${Util.sanitize(bathroom.description)}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>';return eval("`"+template+"`")}function setupSearch(){var e=document.querySelector("#search > input"),t=new google.maps.places.SearchBox(e);t.addListener("places_changed",function(){var e=t.getPlaces();if(e.length){var o=e.shift(),n=new google.maps.LatLngBounds;o.geometry.viewport?n.union(o.geometry.viewport):n.extend(o.geometry.location),_map.fitBounds(n)}}),e.addEventListener("keyup",function(e){27===e.which&&shell.toggleSearch()})}var Constants=require("../../../../assets/js/constants"),Bathroom=require("./bathroom"),ViewModel=require("./viewmodel"),Util=require("../../../../assets/js/util");$http(Constants.API.URL+"status").get().then(function(e){ViewModel.model.view.database.writable=e});var shell=module.exports,MAP_VIEW="map-view",DEFAULT_MAP_OPTIONS={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},_map=void 0,_markers=[],_markerClusterer=void 0,_infoWindow=null;shell.BaseStateController=function(){shell.closePanel()},shell.BathroomStateController=function(e){Bathroom.openPanel(e)},shell.openPanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");return e.classList.remove(Constants.Iden.HIDDEN),t.classList.remove(Constants.Iden.HIDDEN),new Promise(function(t){var o=function o(){e.removeEventListener("transitionend",o),t()};e.addEventListener("transitionend",o)})},shell.closePanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");e.classList.add(Constants.Iden.HIDDEN),t.classList.add(Constants.Iden.HIDDEN)},shell.getLocation=function(){var e=initMap,t=locationUnavailable,o={enableHighAccuracy:!1,timeout:1e4};if(!locationAvailable())return t(),!1;navigator.geolocation.getCurrentPosition(e,t,o)},shell.addMyLocationMarker=function(e,t,o){var n={url:serverRoot+"mobile/assets/images/location.png",size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)};new google.maps.Marker({position:t,title:"My current location",icon:n}).setMap(e),new google.maps.Circle({clickable:!1,strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:e,center:t,radius:o})},shell.getBathrooms=function(){var e=_map.getCenter(),t=e.lat(),o=e.lng();e=new google.maps.LatLng(t,o),$http(Constants.API.URL+"bathroom/get/coords/"+e.toUrlValue()+","+_map.getZoom()+"z").get().then(function(e){e&&attachBathrooms(JSON.parse(e))})},shell.reloadMap=function(){_markers.forEach(function(e){e.setMap(null)}),_markers.length=0,_markerClusterer.clearMarkers(),shell.getBathrooms()},shell.toggleSearch=function(){var e=document.getElementById(Constants.Iden.SEARCH);if(e.classList.toggle(Constants.Iden.HIDDEN),!e.classList.contains(Constants.Iden.HIDDEN)){var t=e.querySelector("input");t.value="",t.focus()}};