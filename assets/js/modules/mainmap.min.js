"use strict";function locationUnavailable(){iqwerty.toast.Toast("Geolocation is not supported on your device"),initBasicMap()}function locationAvailable(){return"geolocation"in navigator}function initBasicMap(){_map=new google.maps.Map(document.getElementById(MAP_VIEW),DEFAULT_MAP_OPTIONS),ViewModel.model.map.instance=_map,updateMapOnMoved()}function initMap(t){var e=t.coords,o=ViewModel.model.map;o.location={lat:e.latitude,lng:e.longitude,accuracy:e.accuracy};var n=Object.assign({},DEFAULT_MAP_OPTIONS);n.zoom=20,n.center={lat:o.location.lat,lng:o.location.lng},_map=new google.maps.Map(document.getElementById(MAP_VIEW),n),ViewModel.model.map.instance=_map,shell.addMyLocationMarker(_map,n.center,o.location.accuracy),updateMapOnMoved(),addBathroomOnClick()}function updateMapOnMoved(){_map.addListener("idle",shell.getBathrooms)}function addBathroomOnClick(){_map.addListener("rightclick",function(t){Bathroom.addBathroom(t.latLng)})}function attachBathrooms(t){var e=[],o=createInfoWindow();t.filter(function(t){return!_markers.find(function(e){return t.id===e.id})}).forEach(function(t){var n=new google.maps.Marker({position:{lat:t.lat,lng:t.lng},icon:Constants.ToiletImage.BATHROOM_MARKER,title:t.approx_address,animation:google.maps.Animation.DROP,id:t.id});n.setMap(_map),n.addListener("click",function(){o.open(_map,n),o.setContent(getInfoWindowContent(t))}),e.push(n)}),_markers.push.apply(_markers,e),_markerClusterer?_markerClusterer.addMarkers(e):_markerClusterer=new MarkerClusterer(_map,_markers,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"})}function createInfoWindow(){return _infoWindow||(_infoWindow=new google.maps.InfoWindow),_infoWindow}function getInfoWindowContent(bathroom){var template='<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${bathroom.description}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>';return eval('`<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${bathroom.description}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t<a class="button button--info-window" onclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\');">more &raquo;</a>\r\n\t</div>\r\n</div>`')}var Constants=require("../../../../assets/js/constants"),Bathroom=require("./bathroom"),ViewModel=require("./viewmodel"),shell=module.exports,MAP_VIEW="map-view",DEFAULT_MAP_OPTIONS={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},_map=void 0,_markers=[],_markerClusterer=void 0,_infoWindow=null;shell.BaseStateController=function(){shell.closePanel()},shell.BathroomStateController=function(t){Bathroom.openPanel(t)},shell.openPanel=function(){var t=document.getElementById("panel"),e=document.getElementById("overlay");return t.classList.remove(Constants.Iden.HIDDEN),e.classList.remove(Constants.Iden.HIDDEN),new Promise(function(e){var o=function o(){t.removeEventListener("transitionend",o),e()};t.addEventListener("transitionend",o)})},shell.closePanel=function(){var t=document.getElementById("panel"),e=document.getElementById("overlay");t.classList.add(Constants.Iden.HIDDEN),e.classList.add(Constants.Iden.HIDDEN)},shell.getLocation=function(){var t=initMap,e=locationUnavailable,o={enableHighAccuracy:!1,timeout:1e4};if(!locationAvailable())return e(),!1;navigator.geolocation.getCurrentPosition(t,e,o)},shell.addMyLocationMarker=function(t,e,o){var n={url:serverRoot+"mobile/assets/images/location.png",size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)};new google.maps.Marker({position:e,title:"My current location",icon:n}).setMap(t),new google.maps.Circle({clickable:!1,strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:t,center:e,radius:o})},shell.getBathrooms=function(){var t=_map.getCenter();$http(Constants.API.URL+"bathroom/get/coords/"+t.lat()+","+t.lng()+","+_map.getZoom()+"z").get().then(function(t){t&&attachBathrooms(JSON.parse(t))})},shell.toggleSearch=function(){var t=document.getElementById(Constants.Iden.SEARCH);t.classList.toggle(Constants.Iden.HIDDEN),t.classList.contains(Constants.Iden.HIDDEN)||t.querySelector("input").focus()};