"use strict";function locationUnavailable(){iqwerty.toast.Toast("Could not retrieve your location"),initBasicMap()}function locationAvailable(){return"geolocation"in navigator}function initBasicMap(){_map=new google.maps.Map(document.getElementById(Constants.Iden.MAP_VIEW),DEFAULT_MAP_OPTIONS),ViewModel.model.map.instance=_map,setupMapHelpers()}function initMap(e){var t=e.coords,n=ViewModel.model.map;n.location={lat:t.latitude,lng:t.longitude,accuracy:t.accuracy};var o=Object.assign({},DEFAULT_MAP_OPTIONS);o.zoom=20,o.center={lat:n.location.lat,lng:n.location.lng},_map=new google.maps.Map(document.getElementById(Constants.Iden.MAP_VIEW),o),ViewModel.model.map.instance=_map,shell.addMyLocationMarker(_map,o.center,n.location.accuracy),setupMapHelpers()}function setupMapHelpers(){_removeMapLoading(),_updateMapOnMoved(),_addBathroomOnClick(),_setupSearch()}function _removeMapLoading(){document.getElementById(Constants.Iden.MAP_VIEW).classList.remove(Constants.Iden.LOADING)}function _updateMapOnMoved(){_map.addListener("idle",shell.getBathrooms)}function _addBathroomOnClick(){_map.addListener("rightclick",function(e){Bathroom.addBathroom(e.latLng)})}function _setupSearch(){var e=document.querySelector("#search > input"),t=new google.maps.places.SearchBox(e);t.addListener("places_changed",function(){var e=t.getPlaces();if(e.length){var n=e.shift(),o=new google.maps.LatLngBounds;n.geometry.viewport?o.union(n.geometry.viewport):o.extend(n.geometry.location),_map.fitBounds(o)}}),e.addEventListener("keyup",function(e){27===e.which&&shell.toggleSearch()})}function attachBathrooms(e){var t=[],n=createInfoWindow();e.filter(function(e){return!_markers.find(function(t){return e.id===t.id})}).forEach(function(e){var o=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},icon:Constants.ToiletImage.BATHROOM_MARKER,title:e.approx_address,animation:google.maps.Animation.DROP,id:e.id});o.setMap(_map),o.addListener("click",function(){n.open(_map,o),n.setContent(getInfoWindowContent(e))}),t.push(o)}),_markers.push.apply(_markers,t),_markerClusterer?_markerClusterer.addMarkers(t):_markerClusterer=new MarkerClusterer(_map,_markers,{imagePath:serverRoot+"mobile/assets/images/clusterer/m"})}function createInfoWindow(){return _infoWindow||(_infoWindow=new google.maps.InfoWindow),_infoWindow}function getInfoWindowContent(bathroom){var template='<div class="info-window flex flex--row">\r\n\t<div class="flex-child flex flex--column info-window--description">\r\n\t\t<div class="address" title="${bathroom.approx_address}">\r\n\t\t\tFree Pee near ${bathroom.approx_address}\r\n\t\t</div>\r\n\t\t<div class="description">\r\n\t\t\t${Util.sanitize(bathroom.description)}\r\n\t\t</div>\r\n\t</div>\r\n\t<div class="flex-child flex">\r\n\t\t\x3c!-- Maybe something should be done about this link... --\x3e\r\n\t\t<a\r\n\t\t\tclass="button button--info-window"\r\n\t\t\thref="${serverRoot}m/bathroom/${bathroom.id}"\r\n\t\t\tonclick="iqwerty.history.Push(\'bathroom/${bathroom.id}\'); return false;">\r\n\t\t\t\tmore &raquo;\r\n\t\t</a>\r\n\t</div>\r\n</div>';return eval("`"+template+"`")}var Constants=require("../../../../assets/js/constants"),Bathroom=require("./bathroom"),ViewModel=require("./viewmodel"),Util=require("../../../../assets/js/util");$http(Constants.API.URL+"status").get().then(function(e){ViewModel.model.view.database.writable=e});var shell=module.exports,DEFAULT_MAP_OPTIONS={zoom:3,center:{lat:0,lng:0},disableDefaultUI:!0},_map=void 0,_markers=[],_markerClusterer=void 0,_infoWindow=null;shell.BaseStateController=function(){shell.closePanel()},shell.BathroomStateController=function(e){Bathroom.openPanel(e)},shell.openPanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");return e.classList.remove(Constants.Iden.HIDDEN),t.classList.remove(Constants.Iden.HIDDEN),new Promise(function(t){var n=function n(){e.removeEventListener("transitionend",n),t()};e.addEventListener("transitionend",n)})},shell.closePanel=function(){var e=document.getElementById("panel"),t=document.getElementById("overlay");e.classList.add(Constants.Iden.HIDDEN),t.classList.add(Constants.Iden.HIDDEN)},shell.getLocation=function(){var e=initMap,t=locationUnavailable,n={enableHighAccuracy:!1,timeout:1e4};if(!locationAvailable())return t(),!1;navigator.geolocation.getCurrentPosition(e,t,n)},shell.addMyLocationMarker=function(e,t,n){var o={url:serverRoot+"mobile/assets/images/location.png",size:new google.maps.Size(20,20),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10)};new google.maps.Marker({position:t,title:"My current location",icon:o}).setMap(e),new google.maps.Circle({clickable:!1,strokeColor:"#00838f",strokeWeight:1,fillColor:"#00838f",fillOpacity:.15,map:e,center:t,radius:n})},shell.getBathrooms=function(){var e=_map.getCenter(),t=e.lat(),n=e.lng();e=new google.maps.LatLng(t,n),$http(Constants.API.URL+"bathroom/get/coords/"+e.toUrlValue()+","+_map.getZoom()+"z").get().then(function(e){e&&attachBathrooms(JSON.parse(e))})},shell.reloadMap=function(){_markers.forEach(function(e){e.setMap(null)}),_markers.length=0,_markerClusterer.clearMarkers(),shell.getBathrooms()},shell.toggleSearch=function(){var e=document.getElementById(Constants.Iden.SEARCH);if(e.classList.toggle(Constants.Iden.HIDDEN),!e.classList.contains(Constants.Iden.HIDDEN)){var t=e.querySelector("input");t.value="",t.focus()}};